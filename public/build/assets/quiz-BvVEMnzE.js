let B=[];window.setupQuiz=function(t,n){const e=document.getElementById("answer"),o=document.getElementById("result"),m=document.getElementById("next-btn"),u=document.getElementById("progress-bar"),i=document.getElementById("counter"),p=JSON.parse(JSON.stringify(t));let b=0,r=0,y=0,w=0,a=0,x=[];function S(){const s=Math.round(a/t.length*100);u.style.width=s+"%",u.textContent=`${s}%`}function C(){const s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttribute("xmlns","http://www.w3.org/2000/svg"),s.setAttribute("width","400"),s.setAttribute("height","400");const d=t[a].text;x=[];for(let f=0;f<d.length;f++){const l=document.createElementNS("http://www.w3.org/2000/svg","text");l.setAttribute("x","50%"),l.setAttribute("y","50%"),l.setAttribute("text-anchor","middle"),l.setAttribute("dominant-baseline","middle"),l.setAttribute("font-size","250"),l.textContent=d[f],s.appendChild(l),x.push(l)}const c=new XMLSerializer().serializeToString(s),L=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(c)}`,v=document.createElement("img");v.setAttribute("src",L),v.setAttribute("alt","quiz image"),v.className="mx-auto mb-4";const E=document.getElementById("mysvg-container");E.innerHTML="",E.appendChild(v),o.textContent="",m.classList.add("hidden"),i.textContent=`問題 ${a+1} / ${t.length}`,S()}document.getElementById("remove-btn").addEventListener("click",()=>{if(x.length>0){const s=x.shift(),d=x.map(c=>c.textContent).join("");t[a].text=d,C(),e.value+=s.textContent,b++,A({hint:!0})}}),document.getElementById("hint-btn").addEventListener("click",()=>{$(t[a].text),r++,A({flashcard:!0})}),document.getElementById("check-btn").addEventListener("click",()=>{const s=p[a].text,d=e.value.trim(),c=d===s;o.textContent=c?"正解！🎉":"不正解…",o.style.color=c?"green":"red",w++,c&&y++,B.push({text:s,user:d,correct:c}),A({play:!0,correct:c}),m.classList.remove("hidden")}),m.addEventListener("click",()=>{if(a++,M(),a<t.length)C(),e.value="";else{S();const s=Math.round(y/w*100);let d=`
                <h2 class="text-xl font-bold text-center mb-6">結果発表</h2>
                <div class="space-y-2 text-lg">
                    <p>正解数：<span class="font-semibold">${y}</span> / ${w}（正解率 ${s}%）</p>
                    <p>ヒント使用：<span class="font-semibold">${b}</span> 回</p>
                    <p>フラッシュカード使用：<span class="font-semibold">${r}</span> 回</p>
                </div>
    
                <h3 class="mt-6 text-lg font-semibold">出題内容と結果</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
            `;B.forEach(c=>{const g=document.createElementNS("http://www.w3.org/2000/svg","svg");g.setAttribute("xmlns","http://www.w3.org/2000/svg"),g.setAttribute("width","200"),g.setAttribute("height","100"),g.setAttribute("viewBox","0 0 200 100");for(let I=0;I<c.text.length;I++){const h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x","100"),h.setAttribute("y","60"),h.setAttribute("text-anchor","middle"),h.setAttribute("font-size","60"),h.setAttribute("font-family","serif"),h.textContent=c.text[I],g.appendChild(h)}const L=new XMLSerializer().serializeToString(g),E=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(L)}`,f=c.correct?"◯":"×",l=c.correct?"text-green-600":"text-red-600";d+=`
                    <div class="border p-4 rounded shadow">
                        <img src="${E}" alt="重ね文字" class="mx-auto mb-2" />
                        <p class="${l} font-bold">${f} あなたの答え：${c.user}</p>
                        <p class="text-sm text-gray-500">正解：${c.text}</p>
                    </div>
                `}),d+=`</div>
                <div class="mt-8 text-center">
                    <a href="/" class="text-blue-600 underline">← ホームへ戻る</a>
                </div>`,document.getElementById("quiz-area").innerHTML=d}});function A(s){fetch("/api/word-statistics/update",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":n},body:JSON.stringify({word_id:t[a].id,...s})})}C()};function $(t){const n=document.getElementById("modal-bg"),e=document.getElementById("modal");e.innerHTML="",n.style.display="flex";let o=3;e.textContent=o;let m=setInterval(()=>{o--,o>0?e.textContent=o:(clearInterval(m),setTimeout(()=>{e.innerHTML="";const u="http://www.w3.org/2000/svg";let i=document.createElementNS(u,"svg");i.setAttribute("width","200"),i.setAttribute("height","120"),i.setAttribute("viewBox","0 0 200 120"),i.style.display="block",e.appendChild(i);let p=0,b=setInterval(()=>{if(p<t.length){const r=document.createElementNS(u,"text");r.setAttribute("x",50),r.setAttribute("y",90),r.setAttribute("font-size",80),r.setAttribute("font-family","serif"),r.textContent=t[p],i.appendChild(r),p++}else clearInterval(b),setTimeout(()=>{n.style.display="none"},800)},70)},300))},600)}document.addEventListener("DOMContentLoaded",function(){const t=document.querySelectorAll(".hint-area button"),n=document.getElementById("answer");t.forEach(e=>{e.addEventListener("click",()=>{const o=e.textContent;n.value=o,n.focus()})})});function M(){const t=document.querySelectorAll(".hint-area button");B.forEach(n=>{t.forEach(e=>{n.text==e.textContent&&e.remove()})})}document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("toggleHint"),n=document.getElementById("hintArea"),e=document.getElementById("toggleIcon");let o=!1;t.addEventListener("click",()=>{var i;o=!o,n.classList.toggle("hidden",!o),e.classList.toggle("rotate-180",o),(i=t.querySelector("span"))==null||i.remove();const u=document.createElement("span");u.textContent=o?"ヒントを隠す":"ヒントを表示",t.appendChild(u)});const m=document.createElement("span");m.textContent="ヒントを表示",t.appendChild(m)});document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll("img").forEach(function(n){n.addEventListener("contextmenu",function(e){e.preventDefault()})})});document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("settings-btn"),n=document.getElementById("settings-modal-bg"),e=document.getElementById("settings-close-btn");t.addEventListener("click",()=>{n.classList.remove("hidden"),n.classList.add("flex")}),e.addEventListener("click",()=>{n.classList.add("hidden"),n.classList.remove("flex")})});
