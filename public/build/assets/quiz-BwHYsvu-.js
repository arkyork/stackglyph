let B=[];window.setupQuiz=function(t,c){const e=document.getElementById("answer"),s=document.getElementById("result"),u=document.getElementById("next-btn"),m=document.getElementById("progress-bar"),r=document.getElementById("counter"),p=JSON.parse(JSON.stringify(t));let f=0,d=0,y=0,E=0,a=0,x=[];function L(){const n=Math.round(a/t.length*100);m.style.width=n+"%",m.textContent=`${n}%`}function C(){const n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.setAttribute("width","400"),n.setAttribute("height","400");const i=t[a].text;x=[];for(let b=0;b<i.length;b++){const l=document.createElementNS("http://www.w3.org/2000/svg","text");l.setAttribute("x","50%"),l.setAttribute("y","50%"),l.setAttribute("text-anchor","middle"),l.setAttribute("dominant-baseline","middle"),l.setAttribute("font-size","250"),l.textContent=i[b],n.appendChild(l),x.push(l)}const o=new XMLSerializer().serializeToString(n),I=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(o)}`,v=document.createElement("img");v.setAttribute("src",I),v.setAttribute("alt","quiz image"),v.className="mx-auto mb-4";const w=document.getElementById("mysvg-container");w.innerHTML="",w.appendChild(v),s.textContent="",u.classList.add("hidden"),r.textContent=`問題 ${a+1} / ${t.length}`,L()}document.getElementById("remove-btn").addEventListener("click",()=>{if(x.length>0){const n=x.shift(),i=x.map(o=>o.textContent).join("");t[a].text=i,C(),e.value+=n.textContent,f++,A({hint:!0})}}),document.getElementById("hint-btn").addEventListener("click",()=>{$(t[a].text),d++,A({flashcard:!0})}),document.getElementById("check-btn").addEventListener("click",()=>{const n=p[a].text,i=e.value.trim(),o=i===n;s.textContent=o?"正解！🎉":"不正解…",s.style.color=o?"green":"red",E++,o&&y++,B.push({text:n,user:i,correct:o}),A({play:!0,correct:o}),u.classList.remove("hidden")}),u.addEventListener("click",()=>{if(a++,T(),a<t.length)C(),e.value="";else{L();const n=Math.round(y/E*100);let i=`
                <h2 class="text-xl font-bold text-center mb-6">結果発表</h2>
                <div class="space-y-2 text-lg">
                    <p>正解数：<span class="font-semibold">${y}</span> / ${E}（正解率 ${n}%）</p>
                    <p>ヒント使用：<span class="font-semibold">${f}</span> 回</p>
                    <p>フラッシュカード使用：<span class="font-semibold">${d}</span> 回</p>
                </div>
    
                <h3 class="mt-6 text-lg font-semibold">出題内容と結果</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
            `;B.forEach(o=>{const g=document.createElementNS("http://www.w3.org/2000/svg","svg");g.setAttribute("xmlns","http://www.w3.org/2000/svg"),g.setAttribute("width","200"),g.setAttribute("height","100"),g.setAttribute("viewBox","0 0 200 100");for(let S=0;S<o.text.length;S++){const h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x","100"),h.setAttribute("y","60"),h.setAttribute("text-anchor","middle"),h.setAttribute("font-size","60"),h.setAttribute("font-family","serif"),h.textContent=o.text[S],g.appendChild(h)}const I=new XMLSerializer().serializeToString(g),w=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(I)}`,b=o.correct?"◯":"×",l=o.correct?"text-green-600":"text-red-600";i+=`
                    <div class="border p-4 rounded shadow">
                        <img src="${w}" alt="重ね文字" class="mx-auto mb-2" />
                        <p class="${l} font-bold">${b} あなたの答え：${o.user}</p>
                        <p class="text-sm text-gray-500">正解：${o.text}</p>
                    </div>
                `}),i+=`</div>
                <div class="mt-8 text-center">
                    <a href="/" class="text-blue-600 underline">← ホームへ戻る</a>
                </div>`,document.getElementById("quiz-area").innerHTML=i}});function A(n){fetch("/api/word-statistics/update",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":c},body:JSON.stringify({word_id:t[a].id,...n})})}C()};function $(t){const c=document.getElementById("modal-bg"),e=document.getElementById("modal");e.innerHTML="",c.style.display="flex";let s=3;e.textContent=s;let u=setInterval(()=>{s--,s>0?e.textContent=s:(clearInterval(u),setTimeout(()=>{e.innerHTML="";const m="http://www.w3.org/2000/svg";let r=document.createElementNS(m,"svg");r.setAttribute("width","200"),r.setAttribute("height","120"),r.setAttribute("viewBox","0 0 200 120"),r.style.display="block",e.appendChild(r);let p=0,f=setInterval(()=>{if(p<t.length){const d=document.createElementNS(m,"text");d.setAttribute("x",50),d.setAttribute("y",90),d.setAttribute("font-size",80),d.setAttribute("font-family","serif"),d.textContent=t[p],r.appendChild(d),p++}else clearInterval(f),setTimeout(()=>{c.style.display="none"},800)},70)},300))},600)}document.addEventListener("DOMContentLoaded",function(){const t=document.querySelectorAll(".hint-area button"),c=document.getElementById("answer");t.forEach(e=>{e.addEventListener("click",()=>{const s=e.textContent;c.value=s,c.focus()})})});function T(){const t=document.querySelectorAll(".hint-area button");B.forEach(c=>{t.forEach(e=>{c.text==e.textContent&&e.remove()})})}document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("toggleHint"),c=document.getElementById("hintArea"),e=document.getElementById("toggleIcon");let s=!1;t.addEventListener("click",()=>{var r;s=!s,c.classList.toggle("hidden",!s),e.classList.toggle("rotate-180",s),(r=t.querySelector("span"))==null||r.remove();const m=document.createElement("span");m.textContent=s?"ヒントを隠す":"ヒントを表示",t.appendChild(m)});const u=document.createElement("span");u.textContent="ヒントを表示",t.appendChild(u)});
