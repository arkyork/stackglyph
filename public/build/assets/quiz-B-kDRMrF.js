window.setupQuiz=function(n,v){const r=document.getElementById("answer"),l=document.getElementById("result"),m=document.getElementById("next-btn"),g=document.getElementById("progress-bar"),d=document.getElementById("counter"),p=JSON.parse(JSON.stringify(n));let w=0,i=0,y=0,A=0,c=0,h=[],B=[];function $(){const t=Math.round(c/n.length*100);g.style.width=t+"%",g.textContent=`${t}%`}function C(){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.setAttribute("width","400"),t.setAttribute("height","400");const s=n[c].text;h=[];for(let b=0;b<s.length;b++){const o=document.createElementNS("http://www.w3.org/2000/svg","text");o.setAttribute("x","50%"),o.setAttribute("y","50%"),o.setAttribute("text-anchor","middle"),o.setAttribute("dominant-baseline","middle"),o.setAttribute("font-size","250"),o.textContent=s[b],t.appendChild(o),h.push(o)}const e=new XMLSerializer().serializeToString(t),S=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(e)}`,x=document.createElement("img");x.setAttribute("src",S),x.setAttribute("alt","quiz image"),x.className="mx-auto mb-4";const f=document.getElementById("mysvg-container");f.innerHTML="",f.appendChild(x),l.textContent="",m.classList.add("hidden"),d.textContent=`問題 ${c+1} / ${n.length}`,$()}document.getElementById("remove-btn").addEventListener("click",()=>{if(h.length>0){const t=h.shift(),s=h.map(e=>e.textContent).join("");n[c].text=s,C(),r.value+=t.textContent,w++,E({hint:!0})}}),document.getElementById("hint-btn").addEventListener("click",()=>{T(n[c].text),i++,E({flashcard:!0})}),document.getElementById("check-btn").addEventListener("click",()=>{const t=p[c].text,s=r.value.trim(),e=s===t;l.textContent=e?"正解！🎉":"不正解…",l.style.color=e?"green":"red",A++,e&&y++,B.push({text:t,user:s,correct:e}),E({play:!0,correct:e}),m.classList.remove("hidden")}),m.addEventListener("click",()=>{if(c++,c<n.length)C(),r.value="";else{$();const t=Math.round(y/A*100);let s=`
                <h2 class="text-xl font-bold text-center mb-6">結果発表</h2>
                <div class="space-y-2 text-lg">
                    <p>正解数：<span class="font-semibold">${y}</span> / ${A}（正解率 ${t}%）</p>
                    <p>ヒント使用：<span class="font-semibold">${w}</span> 回</p>
                    <p>フラッシュカード使用：<span class="font-semibold">${i}</span> 回</p>
                </div>
    
                <h3 class="mt-6 text-lg font-semibold">出題内容と結果</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
            `;B.forEach(e=>{const a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttribute("xmlns","http://www.w3.org/2000/svg"),a.setAttribute("width","200"),a.setAttribute("height","100"),a.setAttribute("viewBox","0 0 200 100");for(let I=0;I<e.text.length;I++){const u=document.createElementNS("http://www.w3.org/2000/svg","text");u.setAttribute("x","100"),u.setAttribute("y","60"),u.setAttribute("text-anchor","middle"),u.setAttribute("font-size","60"),u.setAttribute("font-family","serif"),u.textContent=e.text[I],a.appendChild(u)}const S=new XMLSerializer().serializeToString(a),f=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(S)}`,b=e.correct?"◯":"×",o=e.correct?"text-green-600":"text-red-600";s+=`
                    <div class="border p-4 rounded shadow">
                        <img src="${f}" alt="重ね文字" class="mx-auto mb-2" />
                        <p class="${o} font-bold">${b} あなたの答え：${e.user}</p>
                        <p class="text-sm text-gray-500">正解：${e.text}</p>
                    </div>
                `}),s+=`</div>
                <div class="mt-8 text-center">
                    <a href="/" class="text-blue-600 underline">← ホームへ戻る</a>
                </div>`,document.getElementById("quiz-area").innerHTML=s}});function E(t){fetch("/api/word-statistics/update",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":v},body:JSON.stringify({word_id:n[c].id,...t})})}C()};function T(n){const v=document.getElementById("modal-bg"),r=document.getElementById("modal");r.innerHTML="",v.style.display="flex";let l=3;r.textContent=l;let m=setInterval(()=>{l--,l>0?r.textContent=l:(clearInterval(m),setTimeout(()=>{r.innerHTML="";const g="http://www.w3.org/2000/svg";let d=document.createElementNS(g,"svg");d.setAttribute("width","200"),d.setAttribute("height","120"),d.setAttribute("viewBox","0 0 200 120"),d.style.display="block",r.appendChild(d);let p=0,w=setInterval(()=>{if(p<n.length){const i=document.createElementNS(g,"text");i.setAttribute("x",50),i.setAttribute("y",90),i.setAttribute("font-size",80),i.setAttribute("font-family","serif"),i.textContent=n[p],d.appendChild(i),p++}else clearInterval(w),setTimeout(()=>{v.style.display="none"},800)},70)},300))},600)}
